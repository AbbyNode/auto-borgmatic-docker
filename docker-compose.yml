services:
  # One-time initialization service
  borgmatic-init:
    image: ghcr.io/borgmatic-collective/borgmatic:latest
    container_name: borgmatic-init
    environment:
      - BORG_PASSPHRASE=${BORG_PASSPHRASE:-CHANGE_ME_TO_A_SECURE_PASSPHRASE}
    env_file:
      - .secrets
    volumes:
      - ./borg-repository:/mnt/borg-repository
      - borgmatic-cache:/root/.cache/borg
      - borgmatic-config:/root/.config/borg
    # Initialize repository if it doesn't exist, then exit
    entrypoint: /bin/sh
    command: -c "if [ ! -f /mnt/borg-repository/config ]; then borg init --encryption repokey-blake2 /mnt/borg-repository && echo 'Repository initialized'; else echo 'Repository already exists'; fi"
    restart: "no"

  borgmatic:
    image: ghcr.io/borgmatic-collective/borgmatic:latest
    container_name: borgmatic
    depends_on:
      borgmatic-init:
        condition: service_completed_successfully
    environment:
      - BORG_PASSPHRASE=${BORG_PASSPHRASE:-CHANGE_ME_TO_A_SECURE_PASSPHRASE}
    env_file:
      - .secrets
    volumes:
      # Source directories to backup (add more as needed)
      - ./data:/mnt/source:ro
      # Borg repository location
      - ./borg-repository:/mnt/borg-repository
      # Borgmatic configuration
      - ./config.yaml:/etc/borgmatic.d/config.yaml:ro
      # Borgmatic cache and state
      - borgmatic-cache:/root/.cache/borg
      - borgmatic-config:/root/.config/borg
    labels:
      # Ofelia job to run borgmatic backup daily at 2 AM
      ofelia.enabled: "true"
      ofelia.job-exec.borgmatic-backup.schedule: "0 2 * * *"
      ofelia.job-exec.borgmatic-backup.command: "borgmatic create --stats --verbosity 1"
    restart: unless-stopped

  ofelia:
    image: mcuadros/ofelia:latest
    container_name: ofelia
    depends_on:
      - borgmatic
    command: daemon --docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped

volumes:
  borgmatic-cache:
    driver: local
  borgmatic-config:
    driver: local
